#!/bin/bash

PROG_DIR=$PWD/`dirname $0`

PORTs="8080\n8081\n8082\n8083\n8084\n8085\n8086"

function enablePort() {
	if [ "`sudo iptables --list | grep $1`" = "" ]
	then
		sudo iptables -A INPUT -p tcp --dport $1 -j ACCEPT
	fi
}

function enablePorts() {
	for port in `echo -e $PORTs`
	do
		enablePort $port
	done
}

function run(){
	echo "Starting..."

	for service in `ls -l | grep "^d" | tr -s ' ' | cut -d ' ' -f 9`
	do
		SCREEN_NAME=$service
		scr=`screen -list | grep "${SCREEN_NAME}" | tr -s '\t' | sed "s/\t/ /g" | tr -s ' ' | cut -d ' ' -f 2`

		while ! [ "$scr" = "" ]
		do
			echo "Waiting for ${SCREEN_NAME}..."
			screen -S $scr -X stuff "^C"
			screen -S $scr -X stuff "exit\n"
			scr=`screen -list | grep "${SCREEN_NAME}" | tr -s '\t' | sed "s/\t/ /g" | tr -s ' ' | cut -d ' ' -f 2`
		done

		screen -dmS ${SCREEN_NAME}
		screen -S ${SCREEN_NAME} -X stuff "cd ${SCREEN_NAME}\n"
		screen -S ${SCREEN_NAME} -X stuff "mvn spring-boot:run\n"
	done

	enablePorts

	exit 0
}

while [ -n "$1" ]; do
	case "$1" in
		-r)
			run
			;;
		*)
			echo "Option $1 not recognized"
			exit 1 ;;
	esac

	shift
done

git pull
./`basename $0` -r

exit 0
